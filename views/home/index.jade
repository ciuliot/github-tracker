extend ../layouts/page_layout

block head
	title GitHub tracker
	script(type='text/javascript').
		var MainModule = "viewmodels/home_view_model";
	script(data-main='/js/config', src='/js/libs/require.js')


	<!-- Templates -->

	script#new-branch-template(type="text/html")
		p Test 

	script#user-template(type="text/html")
		li(data-bind="css: { active: $root.selectedUser() === $data }")
			a(href="#", role="menuitem", data-bind="text: $data, click: $root.selectUser.bind($root, $data)") 

	script#user-repositories-template(type="text/html")
		li(data-bind="css: { active: $root.selectedRepository() === $data.name() }")
			a(href="#" data-bind="text: name, click: $root.selectRepository.bind($root, $data.name())") 

	script#milestone-template(type="text/html")
		li(data-bind="css: { active: $root.selectedMilestone() === $data.number() }")
			a(href="javascript:void(0)")
				<!-- span.badge.pull-right(data-bind="text: (id === null || id === 'none') ? '' : open_issues") -->
				span(data-bind="text: title, click: $root.selectMilestone.bind($root, $data.number())") 

	script#issue-phase-header-template(type="text/html")
		.col-lg-3.phase-header(data-bind="text: name, visible: isColumnVisible()")

	script#issue-phase-template(type="text/html")
		.col-lg-3(data-bind="template: { name: 'issue-template', foreach: filteredIssues}, visible: isColumnVisible()")

	script#issue-category-header-template(type="text/html")
		li: a(data-bind="text: name, attr: { href: id() }")

	script#issue-template(type="text/html")
		.panel.panel-default.issue
			.panel-heading(data-bind="style: { background: category().color() }")
				strong(data-bind="text: ('#' + number() + ' '), tooltip: { title: category().name() }")
				a.title(data-bind="click: $root.issueOpen.bind($root, $data)", data-toggle="modal", data-target="#issue-modal")
					strong(data-bind="text: title")
				span.badge.pull-right(data-bind="text: estimate")

			.panel-body
				img.avatar(data-bind="attr: { src: assignee().avatar_url() }, visible: assignee().avatar_url() !== null")
				span.type.label.label-default(data-bind="text: type().name, style: { 'background-color': '#' + type().color() }")
				.actions.btn-group.btn-group-sm.pull-right
					.btn-group.btn-group-sm
						button.btn.btn-default.dropdown-toggle(type="button", data-bind=" css: { hide: !canAssign() } , tooltip: { title: assigneeTooltip, container: 'body' }", data-toggle="dropdown")
							img.img-rounded.issue-assignee-avatar(data-bind="attr: { src: assignee().avatar_url() || '/images/question_mark.svg' }")
							span.caret
						ul.dropdown-menu(role="menu", data-bind="foreach: collaborators", aria-labelledby="assignee-menu")
							li(data-bind="css: { active: login() === $parent.assignee().login() }")
								a(href="#", data-bind="click: $root.assignIssue.bind($root, $parent, $data)") 
									img.img-rounded.issue-assignee-avatar(data-bind="attr: { src: avatar_url() || '/images/question_mark.svg' }")
									span(data-bind="text: login() || 'Unassigned' ")
					.btn-group.btn-group-sm
						button.btn.btn-default.dropdown-toggle(type="button", data-bind="css: { hide: !haveBranch() }, tooltip: { title: 'Branch information', container: 'body' }", data-toggle="dropdown")
							span.glyphicon.glyphicon-random.issue-assignee-avatar
							span.caret
						ul.dropdown-menu(role="menu", aria-labelledby="branch-menu")
							li.dropdown-header.checkout-command
								form: input(type="text", readonly="readonly", onclick="this.select()", data-bind="attr: { value: checkoutCommand() }")
							li(role="presentation"): a(role="menuitem", data-bind="attr: { href: 'https://github.com/ciuliot/github-tracker/tree/' + branch().name() }", target="_blank") Open branch on GitHub
							
					button.btn.btn-default(type="button", data-bind="css: { hide: !canStart() }, click: $root.issueStart.bind($root, $data), tooltip: { title: 'Start work', container: 'body' }")
						span.glyphicon.glyphicon-play
					a.btn.btn-default(target="_blank", data-bind="attr: { href: compareUrl() === null ? 'javascript:void(0)' : compareUrl() }, css: { hide: !canComplete() }, tooltip: { title: 'Complete work', container: 'body' }")
						span.glyphicon.glyphicon-ok
					button.btn.btn-default(type="button", data-bind="css: { hide: !canReview() }, click: $root.issueReview.bind($root, $data), tooltip: { title: 'Review work', container: 'body' }")
						span.glyphicon.glyphicon-screenshot
					button.btn.btn-default(type="button", data-toggle="modal" data-target="#impediment-modal"
						data-bind="css: { hide: !canPause() }, click: $root.issuePauseOpen.bind($root, $data), tooltip: { title: 'Put work on hold', container: 'body' }")
						span.glyphicon.glyphicon-pause
					button.btn.btn-default(type="button", data-bind="css: { hide: !canStop() }, click: $root.issueStop.bind($root, $data), tooltip: { title: 'Stop work', container: 'body' }")
						span.glyphicon.glyphicon-stop
					button.btn.btn-default(type="button", data-bind="css: { hide: !canAccept() }, click: $root.issueAccept.bind($root, $data), tooltip: { title: 'Accept implementation', container: 'body' }")
						span.glyphicon.glyphicon-thumbs-up
					button.btn.btn-default(type="button", data-toggle="modal" data-target="#reject-implementation-modal"
						data-bind="css: { hide: !canReject() }, click: $root.issueRejectOpen.bind($root, $data), tooltip: { title: 'Reject implementation', container: 'body' }")
						span.glyphicon.glyphicon-thumbs-down		
					span.description(data-bind="text: description")

	script#issue-wrap-template(type="text/html")
		<!-- ko foreach: filteredIssues -->
		.col-lg-3
			<!-- ko template: { name: 'issue-template' } -->
			<!-- /ko --> 
		<!-- /ko -->

block body
	#impediment-modal.modal.fade(data-bind="with: impediment")
		.modal-dialog
			.modal-content
				.modal-header
					button.close(type="button", data-dismiss="modal", aria-hidden="true") &times;
					h4.modal-title(data-bind="text: ('Impediment for issue #' + issue_id()) ")
				.modal-body
					form(role="form")
						.form-group
							p.help-block Please describe why work on this issue is blocked:
							textarea.form-control(rows="3", data-bind="value: description, valueUpdate: 'afterkeydown'")

				.modal-footer
					button.btn.btn-default(type="button", data-dismiss="modal") Close
					button.btn.btn-primary(type="button", data-dismiss="modal", data-bind="click: $root.issuePause.bind($root, $data)") Save changes

	#reject-implementation-modal.modal.fade(data-bind="with: rejectImplementation")
		.modal-dialog
			.modal-content
				.modal-header
					button.close(type="button", data-dismiss="modal", aria-hidden="true") &times;
					h4.modal-title(data-bind="text: ('Reject implementation of issue #' + issue_id()) ")
				.modal-body
					form(role="form")
						.form-group
							p.help-block Please describe why implementation should be rejected:
							textarea.form-control(rows="3", data-bind="value: description, valueUpdate: 'afterkeydown'")

				.modal-footer
					button.btn.btn-default(type="button", data-dismiss="modal") Close
					button.btn.btn-primary(type="button", data-dismiss="modal", data-bind="click: $root.issueReject.bind($root, $data)") Save changes

	#issue-modal.modal.fade(data-bind="with: $root.issueDetail")
		.modal-dialog
			.modal-content
				.modal-header
					button.close(type="button", data-dismiss="modal", aria-hidden="true") &times;
					h4.modal-title(data-bind="text: number() === null ? 'New issue' : ('Issue #' + number()) ")
				.modal-body
					form(role="form")
						.form-data
							label(for="type") Issue type:
							br
							.btn-group.btn-group-sm(data-bind="foreach: mainLabelsViewModel.labels().types")
								button.btn.btn-default(type="button", data-bind="text: name, css: { active: id() === $parent.type().id() }, click: $root.changeDetailIssueType.bind($root, $data)")		
						.form-data
							label(for="category") Category:
							select#category.form-control(data-bind="options: mainLabelsViewModel.labels().categories, optionsText: 'name', optionsValue: 'id', value: category().id") 
						.form-data
							label(for="milestone") Milestone:
							select#milestone.form-control(data-bind="options: $root.issueMilestones, optionsText: 'title', optionsValue: 'number', value: milestone") 
						.default(data-bind="visible: type().id() === null")
							include ../partials/default
						.feature(data-bind="visible: type().id() === 'feature'")
							include ../partials/feature
						.bug(data-bind="visible: type().id() === 'bug'")
							include ../partials/bug	
				.modal-footer
					button.btn.btn-default(type="button", data-dismiss="modal") Close
					button.btn.btn-primary(type="button", data-dismiss="modal", data-bind="click: $root.issueSave.bind($root, $data)") Save changes

	nav.navbar.navbar-default(role="navigation")
		.navbar-header
			button.navbar-toggle(type="button", data-toggle="collapse" data-target="#home-navbar-collapse")
				span.sr-only Toggle navigation
				span.icon-bar
				span.icon-bar
				span.icon-bar
			a.navbar-brand Tracker
		.collapse.navbar-collapse#home-navbar-collapse
			ul.nav.navbar-nav				
				li.dropdown
					a.dropdown-toggle(href="#", data-toggle="dropdown")
						span(data-bind="text: selectedUser() === null ? 'Users' : selectedUser()")
						b.caret
					ul.dropdown-menu(data-bind="template: { name: 'user-template', foreach: users }")
				li.dropdown
					a.dropdown-toggle(href="#", data-toggle="dropdown")
						span(data-bind="text: selectedRepository() === null ? 'Repositories' : selectedRepository()")
						b.caret
					ul.dropdown-menu(data-bind="template: { name: 'user-repositories-template', foreach: userRepositories }")
						
				li.dropdown
					a.dropdown-toggle(href="#", data-toggle="dropdown")
						span(data-bind="text: selectedMilestoneTitle()")
						b.caret
					ul.dropdown-menu
						li.disabled: a(href="javascript:void(0)") Add new milestone
						li.divider
						<!-- ko template { name: 'milestone-template', foreach: milestones } -->			
						<!-- /ko -->
			ul.nav.navbar-nav.navbar-right
				li: p.saving-indicator.navbar-text(data-bind="css: { invisible: savingCount() == 0 }")
				li: p.loading-indicator.navbar-text(data-bind="css: { invisible: loadingCount() == 0 }")
				li: .btn-group
					button.btn.btn-default.navbar-btn(type="button", 
						data-bind="tooltip: { title: 'View tasks in backlog', container: 'body', placement: 'bottom' }, click: $root.selectMode.bind($root, 'backlog'), css: { active: $root.mode() === 'backlog' }")
						span.glyphicon.glyphicon-share-alt
					button.btn.btn-default.navbar-btn(type="button", 
						data-bind="tooltip: { title: 'View task board', container: 'body', placement: 'bottom' }, click: $root.selectMode.bind($root, 'board'), css: { active: $root.mode() === 'board' }")
						span.glyphicon.glyphicon-list-alt
					button.btn.btn-default.navbar-btn(type="button", 
						data-bind="tooltip: { title: 'View closed tasks', container: 'body', placement: 'bottom' }, click: $root.selectMode.bind($root, 'closed'), css: { active: $root.mode() === 'closed' }")
						span.glyphicon.glyphicon-folder-close
					
				li
					form.navbar-form(role="form")
						.form-group
							input.form-control(type="text", placeholder="Search", data-bind="value: $root.issuesViewModel.filter, valueUpdate: 'afterkeydown'")
				li
					.btn-group
						button.btn.btn-default.navbar-btn(data-toggle="modal" data-target="#issue-modal"
							data-bind="css: { disabled: selectedRepository() === null }, tooltip: { title: 'Add new issue to product backlog', container: 'body', placement: 'bottom' }, click: $root.issueAdd.bind($root)")
							span.glyphicon.glyphicon-plus
						button.btn.btn-default.navbar-btn(data-bind="css: { disabled: loadingCount() > 0 }, click: $root.reloadIssues.bind($root, true), tooltip: { title: 'Refresh issues', container: 'body', placement: 'bottom' }")
							span.glyphicon.glyphicon-refresh
					
				li.dropdown
					a.dropdown-toggle(href="#", data-toggle="dropdown")
						div
						span(data-bind="text: user().name()") 
						b.caret
					ul.dropdown-menu
						li: a(href="#", data-bind="click: $root.reloadRepositories.bind($root)") Refresh repositories
						li.divider
						li: a(href="/logout") Logout

	#new-branch.alert.alert-info.alert-dismissable.fade
		button(type="button", class="close", data-dismiss="alert", aria-hidden="true") &times;
		strong 
			span New branch was created. Please see issue branch details.

	.container-fluid.visible-lg(data-bind="with: issuesViewModel.categories()[0]")
		.row.phases(data-bind="template: { name: 'issue-phase-header-template', foreach: phases }")
	.container-fluid
		<!-- ko foreach: issuesViewModel.categories() -->
		div(data-bind="visible: $root.mode() === 'board' && visibleIssueCount() > 0")
			.row.phase(data-bind="template: { name: 'issue-phase-template', foreach: phases } , css: { 'top-priority': isTopPriority }")
		<!-- /ko -->
		<!-- ko foreach: issuesViewModel.categories() -->
		div(data-bind="visible: $root.mode() !== 'board'")
			.row.phase(data-bind="template: { name: 'issue-wrap-template', foreach: rows } , css: { 'top-priority': isTopPriority }, visible: rows().length > 0")
		<!-- /ko -->
				
				
		




